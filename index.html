<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mail</title>
  <style>
    * {
      font-family: monospace;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #16161b;
    }

    button {
      cursor: pointer;
    }

    .container {
      display: flex;
      gap: 40px;
    }

    .form {
      min-width: 300px;
      width: 400px;
      max-width: 400px;
      display: flex;
      flex-direction: column-reverse;
      justify-content: center;
      transition: all 0.3s ease;
      padding-block: 50px;

      button {
        margin-top: 20px;
      }

      input {
        padding-bottom: 10px;
      }

      label {
        width: fit-content;
        margin-top: 8px;
        font-size: 18px;
        color: white;
        background-color: transparent;
        border: none;
        font-weight: bold;
        transition: all 0.3s ease;
        margin-bottom: -45px;
        pointer-events: none;
      }

      input, textarea {  
        height: auto;
        background-color: transparent;
        border: none;
        border-bottom: 2px solid white;
        color: white;
        transition: all 0.3s ease;
        margin-top: 20px;
        
        &:focus {
          outline: none;
        }

      }

      textarea {
        width: 100%;
        padding: 0;
        padding-block: 3px;
        resize: none;
      }

      .label2 {
        margin-top: 30px;
        margin-bottom: -55px;
      }
      
      #title {
        &:focus ~ .label1 {
          letter-spacing: 5px;
          margin-bottom: 0;
          font-size: 30px;
        }
        &:placeholder-shown ~ .label1 {
          color: white;
        }
        &:not(:placeholder-shown) ~ .label1 {
          color: lime;
          margin-bottom: 0;
          font-size: 30px;
        }
      }
      #description {
        &:focus ~ .label2 {
          letter-spacing: 5px;
          margin-bottom: 0;
          font-size: 30px;
        }
        &:placeholder-shown ~ .label2 {
          color: white;
        }
        &:not(:placeholder-shown) ~ .label2 {
          color: lime;  
          margin-bottom: 0;
          font-size: 30px;
        }
      }
      /* input:focus ~ .label1 {
        letter-spacing: 5px;
      }
      textarea:focus ~ .label2 {
        letter-spacing: 5px;
      }
      input:placeholder-shown ~ .label1 {
        color: white;
      }
      textarea:placeholder-shown ~ .label2 {
        color: white;
      }
      input:not(:placeholder-shown) ~ .label1 {
        color: lime;
      }
      textarea:not(:placeholder-shown) ~ .label2 {
        color: lime;
      } */
    }


    .preview {
      min-height: 100vh;
      min-width: 300px;
      position: relative;
      /* display: flex;
      flex-direction: column;
      justify-content: center; */

      p {
        color: white;
        font-size: 24px;
        margin: 10px;
        margin-left: -20px;
      }
    }

    .preview-content {
      height: fit-content;
      width: fit-content;
      position: fixed;
      top: 20%;
    }

    .result {
      border: 1px solid white;
      color: white;
      word-wrap: break-word;
      height: 300px;
      width: 300px;
      padding: 3px;
    }

    .link {
      width: 100%;
      display: flex;
      gap: 5px;

      * {
        flex: 1;
        margin-top: 5px !important;
      }

      #open a {
        margin: 0 !important;
        display: block;
        height: 100%;
        width: 100%;
        text-decoration: none;
      }

      #edit {
        display: none;
      }
    }

    .acc-container {
      display: flex;
      position: fixed;
      height: 80px;
      width: 100%;
      top: 0;
      align-items: center;
      justify-content: flex-end;
      gap: 20px;
      margin-right: 40px;

      #info {
        border: none;
        font-size: 14px;
        padding: 0;
      }

      .acc-button {
        display: flex;
        gap: 20px;
      }

      .account {
        height: fit-content;
        padding: 3px 15px;
        color: white;
        border: 2px solid white;
        background-color: transparent;
        font-weight: bold;
        font-size: 18px;
        transition: all 0.3s ease;
        cursor: pointer;
        user-select: none;
      }
      .account:hover {
        background-color: white;
        color: #16161b;
      }

      
      #logout {
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: red;
        color: white;
        height: 20px;
        width: 0;
        transition: all 0.3s ease;
        overflow: hidden;
        cursor: pointer;
      }

      #user {
        margin-right: 10px;
      }

      #userWrap {
        display: flex;
        align-items: center;

        &:hover > #logout {
          width: 20px;
        }
      }

    }

    @media screen and (max-width: 920px) {
      body {
        display: flex;
        flex-direction: column;
      }
      .acc-container {
        display: flex;
        flex-direction: column;
        height: fit-content;
        position: relative;
        gap: 10px;
        align-items: flex-end;
        margin-top: 20px;

        .acc-button {
          gap: 10px;
        }
      }
      .container {
        flex-direction: column-reverse;
        gap: 30px;
      }

      .preview {
        min-height: fit-content;

        .preview-content {
          position: relative;
        }
      }

      #userWrap:active #logout {
        width: 20px;
      }

    }
  </style>
</head>
<body>
  <div class="acc-container">
    <div id="userWrap">
    </div>
  </div>
  <div class="container">
    <form class="form">
      <div class="link">
        <button id="copyLink" type="button" disabled>Copy Link</button> 
        <button id="open" disabled><a id="openLink" target="_blank">Open In New Tab</a></button>
      </div>
      <div class="link">
        <button id="generate" type="submit">Generate</button>
        <button id="edit" type="submit">Edit</button>
      </div>
      <textarea name="" id="description" placeholder=" "></textarea>
      <label for="description" class="label2">Description</label>
      <input type="text" id="title" placeholder=" ">
      <label for="title" class="label1">Title</label>
    </form>
    <div class="preview">
      <div class="preview-content">
        <p>Preview :</p>
        <iframe class="result"></iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import { createData, updateData, readingToken } from './module.js'

    var title = document.getElementById('title');
    var description = document.getElementById('description');
    var result = document.querySelector('.result');
    var copyLink = document.getElementById('copyLink');
    var label = document.querySelectorAll('label');
    var openlink = document.getElementById('openlink');
    var openBtn = document.getElementById('open');
    const form = document.querySelector('.form');
    const accWrap = document.querySelector('.acc-container');
    var focused;
    
    document.addEventListener('DOMContentLoaded', () => {

      setTimeout(() => {
        console.log('load')

        async function loadAcc() {
          const account = await readingToken();
          console.log(account)

          if (account && localStorage.getItem('token')) {
            const username = document.createElement('div')
            username.setAttribute('class', 'account');
            username.setAttribute('id', 'user');
            username.innerHTML = account.username;

            const logout = document.createElement('div');
            logout.setAttribute('id', 'logout');
            logout.innerHTML = 'x';

            const user = document.createElement('div');
            user.setAttribute('id', 'userWrap');
            user.appendChild(username);
            user.appendChild(logout);

            accWrap.appendChild(user)

            console.log('s')

          } else {
            const info = document.createElement('div');
            info.setAttribute('class', 'account');
            info.setAttribute('id', 'info');
            info.innerHTML = 'Use Account to get more feature!';

            const btnWrap = document.createElement('div');
            btnWrap.setAttribute('class', 'acc-button');

            const signin = document.createElement('button');
            signin.setAttribute('class', 'account');
            signin.setAttribute('id', 'signin');
            signin.innerHTML = 'Login';

            const signup = document.createElement('button');
            signup.setAttribute('class', 'account');
            signup.setAttribute('id', 'signup');
            signup.innerHTML = 'Sign Up';

            btnWrap.appendChild(signin);
            btnWrap.appendChild(signup);

            accWrap.appendChild(info);
            accWrap.appendChild(btnWrap);
          }
        }

        loadAcc()
      }, 1000);

      responsive();

      const signin = document.getElementById('signin');
      const signup = document.getElementById('signup');

      window.addEventListener('resize', responsive);
      form.addEventListener('submit', link);
      copyLink.addEventListener('click', copy);
      document.addEventListener('selectionchange', selectionFormating);
      if (signin && signup) {
        signin.addEventListener('click', () => {
          acc(1)
        });
        signup.addEventListener('click', () => {
          acc(2)
        });
      }
    });

    description.addEventListener('input', () => {
      description.style.height = 'auto';
      description.style.height = description.scrollHeight + 'px';
    });

    window.onerror = function(message, source, lineno, colno, error) {
      localStorage.setItem('error', [message,source,lineno,colno,error]); 
    };

    function acc(id) {
      if (id == 1) {
        window.location.href = '/auth/login.html'
      } else if (id == 2) {
        window.location.href = '/auth/signup.html'
      }
    }

    async function link(event) {
      event.preventDefault();

      const id = event.submitter.id[0] == 'g' ? 0 : (event.submitter.id[0] == 'e' ? 1 : null) 

      try {
        
        if (title.value && description.value) {
          console.log(formating(title.value))
          var message_id = await (id == 0 ?
            createData(
              encrypt(formating(title.value)), 
              encrypt(formating(description.value))
            ) : ( id == 1 ?
            updateData(
              localStorage.getItem('id'),
              encrypt(formating(title.value)), 
              encrypt(formating(description.value))
            ) : null
          ))

          if (localStorage.getItem('id')) {
            edit.style.display = 'block'
          }

          var resultSrc = 'Mail.html?id=' + message_id;

          result.src = resultSrc
          openLink.href = resultSrc
          openLink.style.color = 'black'
          openBtn.removeAttribute('disabled')
          copyLink.removeAttribute('disabled')
        } else {
          if (!title.value) {
            label[0].style.color = 'red'
          }
          if (!description.value) {
            label[1].style.color = 'red'
          }
  
          
          setTimeout(() => {
            label.forEach((i, index) => {
              i.removeAttribute('style')
            });
          }, 3000);
        }
      } catch (error) {
        console.error('Error:', error.message);
      }
    }

    function responsive() {
      var form = document.querySelector('.form');
      
      form.style.width = window.innerWidth * 0.5 + 'px'
    }

    function selectionFormating() {
      var selected = window.getSelection();
      var selectionText = selected.toString();
      var enableFormating = true;

      var keyBtn = ['b', 'i', 's', 'p']
      var keyIndi = ['*', '_', '-', '```']

      console.log(selectionText)

      title.addEventListener('click', () => {
        focused = 1
      });
      description.addEventListener('click', () => {
        focused = 2
      });
      var tag = focused == 1 ? title : description
      var indexStart = tag.selectionStart
      
      if (selectionText && enableFormating) {
        console.log('hi')
        enableFormating = false

        document.addEventListener('keydown', fm)

        function fm(event)  {
          console.log(event.key)
          console.log(selectionText)
          var indi = event.key in keyBtn ? keyIndi[keyBtn.indexOf(event.key)] : ''

          console.log(event.ctrlKey, event.key in keyBtn)
          console.log(focused)
          console.log(event.ctrlKey && event.key in keyBtn && focused)

          if (event.ctrlKey && event.key in keyBtn && focused) {
            
            console.log(indexStart)
            console.log(tag)
            console.log(tag.value)
            var spesificRegex = new RegExp(`^.{${indexStart}}(.{${selectionText.length}})`, 'g')
            console.log(tag.value.match(spesificRegex))
            console.log(spesificRegex)
            console.log(selectionText)

            

            tag.value = tag.value.replace(spesificRegex, `${indi}${tag.value.match(spesificRegex)}${indi}`)
            
          }
          
          if (indi) {
            document.removeEventListener('keydown', fm)      
          }
        }
      }
    }

    function encrypt(text) {
      console.log(text)
      var unicode = Array.from(text).map(ord => ord.codePointAt(0));
      console.log(unicode)
      return unicode.map(hex => hex.toString(16)).join('g')
    }

    function formating(text) {
      var character = ['_', '\\*', '-', '```']
      var tag = ['i', 'b', 's', 'pre']
      
      character.map((i, index) => {
        var formatingRegex = new RegExp(`${i}(.*?)${i}`, 'g')
        text = text.replace(formatingRegex, `<${tag[index]}>$1</${tag[index]}>`)
      })

      return text
    }

    function copy() {
      console.log(title.value);
      console.log(description.value);
      var result = document.querySelector('.result').src;

      navigator.clipboard.writeText(result)
    }



    // window.formating = formating;
  </script>
</body>
</html>